{% extends "baseTemplate/index.html" %}
{% load i18n %}

{% block styles %}
    <style>

    </style>
{% endblock %}
{% block title %}{% trans "Restore Website - CyberPanel" %}{% endblock %}
{% block content %}
    {% load static %}
    {% get_current_language as LANGUAGE_CODE %}
    <!-- Current language: {{ LANGUAGE_CODE }} -->


    <div class="container">
        <div id="page-title">
            <h2>{% trans "Restore Website" %} - <a  target="_blank" href="http://go.cyberpanel.net/backup" style="height: 23px;line-height: 21px;" class="btn btn-border btn-alt border-red btn-link font-red" title=""><span>{% trans "Backup Docs" %}</span></a></h2>
            <p>{% trans "This page can be used to restore your websites from backups taken locally." %}</p>
        </div>

        <div id="backupRestoreSiteApp" ng-controller="restoreWebsiteControl" class="panel">
            <div class="panel-body">
                <h3 class="title-hero">
                    {% trans "Restore Website" %} <img ng-hide="restoreLoading" src="{% static 'images/loading.gif' %}">
                </h3>
                <div  class="example-box-wrapper">


                    <form  action="/" class="form-horizontal bordered-row">


                        <div class="form-group">
                            <label class="col-sm-3 control-label">{% trans "Select Website" %} </label>
                            <div class="col-sm-6">
                                <select v-model="selectedSite" @change="getCurrentBackups()" class="form-control">
                                    <option value=""> -Select Site- </option>
                                    <option v-for="website in websitesList">[[ website ]]</option>
                                </select>
                            </div>
                        </div>


                        <!---- if restore is running ----->
                        <div ng-hide="runningRestore" class="form-group">

                            <div  class="col-sm-12">

                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th>{% trans "Condition" %}</th>
                                        <th>{% trans "File Name" %}</th>
                                        <th>{% trans "Status" %} <img ng-hide="restoreFinished" src="{% static 'images/loading.gif' %}"></th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>{$ running $}</td>
                                        <td>{$ fileName $}</td>
                                        <td style="color: red"><strong>{$ status $}</strong></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-3 control-label"></label>
                                <div class="col-sm-4">
                                    <div ng-hide="backupError" class="alert alert-danger">
                                        <p>{% trans "Error message:" %} {$ errorMessage $}</p>
                                    </div>

                                    <div ng-hide="siteExists" class="alert alert-danger">
                                        <p>{% trans "Site related to this Back up already exists." %}</p>
                                    </div>


                                    <div ng-hide="couldNotConnect" class="alert alert-danger">
                                        <p>{% trans "Could not connect to server. Please refresh this page." %}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <div  class="col-sm-12">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th>{% trans "ID" %}</th>
                                        <th>{% trans "File" %}</th>
                                        <th>{% trans "Date" %}</th>
                                        <th>{% trans "Size" %}</th>
                                        <th>{% trans "Status" %}</th>
                                        <th>{% trans "Delete" %}</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr v-for="backup in currentBackups">
                                        <td>[[ backup.id ]]</td>
                                        <td>[[ backup.file ]]</td>
                                        <td>[[ backup.date ]]</td>
                                        <td>[[ backup.size ]]</td>
                                        <td>[[ backup.status ]]</td>
                                        <td><div @click="deleteBackup(backup.id)"><img src="{% static 'images/delete.png' %}"></div></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block footer_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script>
        let backupRestoreSiteApp = new Vue({
            delimiters: ['[[', ']]'],
            el: '#backupRestoreSiteApp',
            data: function () {
                return {
                    selectedSite: "",
                    websitesList: {{ websitesList|safe }},
                    currentBackups: []
                }
            },
            methods: {
                getCurrentBackups: function() {
                    const requestOptions = {
                        method: "POST",
                        headers: {'Content-Type': 'application/json', "X-CSRFToken": getCookie('csrftoken')},
                        body: JSON.stringify({domain: this.selectedSite})
                    }
                    if (this.selectedSite === "") {
                        this.currentBackups = []
                    } else {
                        fetch("/api/v2/backups", requestOptions)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(response.status + " " + response.statusText)
                                }
                                return response.json()
                            })
                            .then(data => this.currentBackups = data)
                            .catch(error => console.error("Error: ", error))
                    }
                },
                deleteBackup: function(backupId) {
                    const requestOptions = {
                        method: "POST",
                        headers: {'Content-Type': 'application/json', "X-CSRFToken": getCookie('csrftoken')},
                        body: JSON.stringify({backupId: backupId})
                    }
                    if (this.selectedSite === "") {
                        this.currentBackups = []
                    } else {
                        fetch("/backup/deleteBackup", requestOptions)
                            .then(resp => {
                                if (resp.ok) {
                                    this.currentBackups = resp
                                }
                            })
                            .catch(error => console.error("Error: ", error))
                    }
                }
            },
        })
    </script>
{% endblock %}